---
title: 代码相关
date: 2020-07-20 10:16
tags:
- java
- company

categories:
- java
- frame
- vertx

password: oodt

abstract: 只是日常自语而已。

message: 我是....？

---

项目相关。
<!--more-->

---

services\static-data 第一个和第二个一起按照文档要求改好版号上传 第三个屏蔽字库，暂时用不到，都是客户端发过来的。
注意gld规范

services\snqu_utils 大佬写的上传，跑一下就可以上传到

common\snqu\games 是Glog

coscmd 上传文件，用的腾讯的一套服务器

苏老师，我对游戏发布的整个流程还是有些模糊：
1. 我们生成的jar和zip然后上传就可以了吗？然后这个上传时用到的是coscmd
2. 是测试那边的人帮忙打包是吗？

3. 本地测试要怎么做呢？

4. 怎么用vertx指令启动服务器？
5. gradle-task-distribution-distzip会给每个子项目都打包 应该用哪一个呢

6. 平时需要关注群里发的问题吗，比如昨天的clientIndex问题

7. 像Executor.waitIf这样的方法是要去了解实现还是知道怎么用就可以

8. Bnet是什么平台吗...?

问题有些多，您可能比较忙，空闲的时候答下就好


7.15


苏俊:
首先，整个发布流程，是先到测试服、然后QA服，如果有iOS/Android提审的话，再到提审服，都测试通过后，再到生产服

苏俊:
目前测试服、QA服，没有做区分

苏俊:
就是有三套服务器，测试、提审、线上。相应地，还分海外版、国内版。目前只有海外版

苏俊:
相应地，会有海外的测试、提审、生产。国内的测试、提审、生产。

苏俊:
国内版本目前有测试、提审，还没有生产服

苏俊:
打包到测试服、提审服时，我们自己上传就可以了。用 services\snqu_utils\upload_jar.py脚本

苏俊:
更新到生产服务器的时候，只有运维有权限。我们把打包好的zip包，传到cos里，由运维来更新

苏俊:
2. 打包肯定是我们开发来打包。测试只是测一下功能是不是正常




--------------------------


苏俊:
3、本地测试的话。需要你在本地机器上，装好相应的开发环境。mysql/redis/rabbitmq ，可以装到docker里，方便些。然后改对应你本地的配置文件，把数据库之类，指向你自己的服务。

苏俊:
4、vertx启动服务器  

苏俊:
[图片]

苏俊:
Main class:  com.bgs.application.blade.game.Launcher
VM options: -Dfile.encoding=UTF-8 -Dlog4j2.configurationFile=log4j2-local.xml -Dvertx.logger-delegate-factory-class-name=io.vertx.core.logging.SLF4JLogDelegateFactory -Dapplication.logName=game
Program arguments: run com.bgs.application.blade.game.Server
Workin directory: E:\projects\Blade\Blade_20200331_dev\blades-backend-20190325\services
其他的service大同小异。改下main class的名字，VMoptins ,program arguments

苏俊:
对比下截图，能看出来

苏俊:
5、distzip是每个服务一个zip包，所有服务都需要

苏俊:
所有的zip都需要

苏俊:
6、目前看下就可以了，知道有这么个问题。对代码有点熟悉时，有时间可以对着代码熟悉下

oodt:
但是那样的话不是会重复很多依赖吗..

苏俊:
是的。开发、提审的部署相同，相同的jar，都在同一个目录下。生产的部署，是每个service一个独立的文件夹。

苏俊:
每个service,都是独立的java命令启动的

苏俊:
7. 知道怎么用就行了，感兴趣的话，了解下实现。我也没去深入了解过

苏俊:
8. Bnet 是我们这游戏的CP。 我们是代理

苏俊:
162.14.16.220/150.109.150.169 root UpQBCu7886xRiJUS

苏俊:
香港测试服的账号，你可以登录上去看下

oodt:
好的

苏俊:
/opt/blade目录下

苏俊:
lib 是所有公用jar的目录

苏俊:
bin是各个service的目录



今日心得：不要困在整个大函数中。我其实之前往里找waitfor的时候就有这种感觉了，里面非常复杂且黑科技。有好几层的嵌套，全部理解相当的困难。现在我想找到为什么我在本地跑的时候他就知道是local，收获的话是确实是个非常紧密的部件工程，比如会用到.properties，这个properties可能是在其他的文件夹下(services\library-common\src\main\resources\blade-local.properties)，而且会知道用的是local，这时候是（可能）gradle在起作用，它调用的services:game:Launcher.main()里面会有很多的log4j的log，你会发现它们其实来自各地，比如：
```
services\library-common\src\main\java\com\bgs\library\common\configuration\CommandLineConfigurator.java:
[2020-07-15T14:20:03+0800] [main] [WARN] [configuration.CommandLineConfigurator] No visibility was passed in, using default visibility.

services\library-common\src\main\java\com\bgs\library\common\configuration\ServerConfigurator.java：
[2020-07-15T14:20:03+0800] [main] [INFO] [configuration.ServerConfigurator] Selected environment is: local
```
就这样找到了local，后面就会告诉你用到了game-local.properties了，于是配置什么的就都加载好了。
我现在怀疑就是gradle了，在gradlew.bat里有这样一句:if "%OS%"=="Windows_NT" setlocal
这样我就明白了，java -jar后面的参数是gradle给的


---
docker

docker run -dit --name Myrabbitmq -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=admin -p 15672:15672 -p 5672:5672 rabbitmq

docker run -dit --name Myrabbitmq -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=admin -p 15672:15672 -p 5672:5672 rabbitmq:managemen


docker run -itd --name mysql-test -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql

docker run -itd --name redis-test -p 6379:6379 redis

docker exec -it redis-test /bin/bash
redis-cli

mysql -h localhost -u root -p

-p

mv /etc/apt/sources.list /etc/apt/sources.list.bak
echo "deb http://mirrors.163.com/debian/ jessie main non-free contrib" >/etc/apt/sources.list
echo "deb http://mirrors.163.com/debian/ jessie-proposed-updates main non-free contrib" >>/etc/apt/sources.list
echo "deb-src http://mirrors.163.com/debian/ jessie main non-free contrib" >>/etc/apt/sources.list
echo "deb-src http://mirrors.163.com/debian/ jessie-proposed-updates main non-free contrib" >>/etc/apt/sources.list
apt-get update 
apt-get install -y vim
netstat -ano|findstr  1099
taskkill -f -pid 进程号


"registry-mirrors": [
    "https://hub-mirror.c.163.com",
    "https://registry.aliyuncs.com",
    "https://registry.docker-cn.com",
    "https://docker.mirrors.ustc.edu.cn"
  ],

  文件夹内:
  /tools 代码
  /tests 似乎是读取测试数据用的
  /service 不用说了吧
  /prometheus 服务监控系统
  /portal 用Angular CLI的不知道干啥的 //--7.20 可能是服务器组件
  /ping-network 代码
  /on :Tool to switch between AWS profiles
  /matchmaking-simulation 估计是pvp的东西?
  /local-servers 一些docker脚本，我先用了，应该没什么影响，毕竟叫local
  /libs service-api-3.32.0?啥
  /infra 是代码，但是是什么代码呢..
  /grafana grafana 是一款采用 go 的时序数据展示工具
  /docs 使用的外部工具用文档
  /deploy 部署用的吧
  /configs 配置，很怪，可能是整体的
  /cloudformation-templates ?


在启动AdminService服务时出现Caused by: com.mysql.cj.jdbc.exceptions.CommunicationsException: Communications link failure，是因为我mysql里没有数据吗（划掉，没填mysql账号密码
Caused by: com.bgs.library.common.exceptions.ServiceErrorException: Request to receive messages from the SQS failed. [httpErrorCode=500, serviceId=21, errorCode=3, debugInformation=[queueName=taskprocessing]] 
orchestrator 端口冲突（划掉，我开了两个？
x


Admin 有问题 [2020-07-17T13:52:22+0800] [main] [DEBUG] [dal.aurora.MigrationUtils] Validating schema: admin
[MDC={}]
[2020-07-17T13:52:23+0800] [main] [ERROR] [admin.Launcher] Unable to validate database schema
[MDC={}]
org.flywaydb.core.api.FlywayException: Validate failed: Schema `admin` doesn't exist yet

通过使用flyway解决，需要注意schemas，table不知道有没有影响，建议使用。不行就clean多试试。
flyway -table=_schema_history -schemas=admin -user=root -password=123456 migrate


Arena正常 8088
Authentication正常 8081
campaign正常 8092
campaignmessage正常 8093
ims 正常 8086
inventory 正常 8082
matchmaking 正常 8084
orchestrator 正常 8095

presence 正常->稍有问题: 8090 ?already inuse bind？
rms 正常->稍有问题: 8091 already in use bind
尝试kill pid 再次执行依然有问题。
是先
[2020-07-17T13:52:57+0800] [vert.x-eventloop-thread-1] [INFO] [core.BaseServer] Deploying server to port: 8090[MDC={}]
[2020-07-17T13:52:57+0800] [vert.x-eventloop-thread-0] [INFO] [core.BaseServer] Deploying server to port: 8090[MDC={}]
然后出的
[2020-07-17T13:52:57+0800] [vert.x-acceptor-thread-0] [ERROR] [impl.HttpServerImpl] java.net.BindException: Address already in use: bind 似乎没有影响

taskprocessing: 很有问题：Caused by: com.bgs.library.common.exceptions.ServiceErrorException: Request to receive messages from the SQS failed. [httpErrorCode=500, serviceId=21, errorCode=3, debugInformation=[queueName=taskprocessing]]
rabbitmq安装了两个版本，删掉其中一个。

analytics 正常 8087

game [2020-07-17T13:47:46+0800] [main] [INFO] [snqu.glog.sender.GLogTCPSenderImpl] Connecting to GLOG server ... [MDC={}]
[2020-07-17T13:47:46+0800] [main] [ERROR] [game.Launcher] Error launching the server[MDC={}] 
java.lang.NullPointerException: no null host accepted
注释glog。





<!doctype html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="java,company," />




  


  <link rel="alternate" href="/atom.xml" title="oodt's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.1" />






<meta name="description" content="代码相关。">
<meta property="og:type" content="article">
<meta property="og:title" content="代码相关">
<meta property="og:url" content="http://oodtoodt.github.io/2020/07/20/%E4%BB%A3%E7%A0%81%E7%9B%B8%E5%85%B3/index.html">
<meta property="og:site_name" content="oodt&#39;s blog">
<meta property="og:description" content="代码相关。">
<meta property="article:published_time" content="2020-07-20T02:16:00.000Z">
<meta property="article:modified_time" content="2020-07-29T09:01:23.756Z">
<meta property="article:author" content="eco_oodt">
<meta property="article:tag" content="java">
<meta property="article:tag" content="company">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://oodtoodt.github.io/2020/07/20/代码相关/"/>





  <title>代码相关 | oodt's blog</title>
  














<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">oodt's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">自杀之路</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://oodtoodt.github.io/2020/07/20/%E4%BB%A3%E7%A0%81%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eco_oodt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/prpr.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="oodt's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">代码相关</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-20T10:16:00+08:00">
                2020-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/frame/" itemprop="url" rel="index">
                    <span itemprop="name">frame</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/frame/vertx/" itemprop="url" rel="index">
                    <span itemprop="name">vertx</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/20/%E4%BB%A3%E7%A0%81%E7%9B%B8%E5%85%B3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/20/代码相关/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2020/07/20/%E4%BB%A3%E7%A0%81%E7%9B%B8%E5%85%B3/" class="leancloud_visitors" data-flag-title="代码相关">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>代码相关。</p>
<a id="more"></a>

<hr>
<h1 id="小tip"><a href="#小tip" class="headerlink" title="小tip:"></a>小tip:</h1><ul>
<li>很多操作时带了getData和setData的，比如如果你从一个Proveider里面取出一个内容，你几乎必然立刻把取出来的这个内容用setData扔进ctx里，文中很多地方没有写ctx相关的内容，并且以后也不打算写。因为ctx无非就是个中间变量，我们取出来，放进一个方便使用的ctx里而已。</li>
<li>provider设计模式的核心概念是入口程序将某个对外提供的服务接口转嫁到不同的provider去实现,而被选择的provider并不是通过继承服务接口去实现服务,而是通过另外的独立的继承途径去实现.相比接口继承实现模式,provider模式提供了更多的可扩展性和灵活性.</li>
<li>数据存在ctx里，这个ctx全名OperationContext操作上下文，可以setData(把指定的数据类型的数据存进去，还可以getData取出来)</li>
<li>封装了流式操作，用ExecutorFactory。(表示链接在一起的步骤链，将按注册顺序执行，如果需要，可以返回最后一步结果的Future，以便与vertx正常链接（compose/map 链接）)</li>
<li>ValidationUtils中的valitdate是用来确认是否实现了validatable接口，然后根据这个接口来判断新的错误(两层thorw吧应该就算)</li>
<li>注意waitfor可能有多种实现，看到逗号分隔的式子时先看前面的waitfor之类的参数<br>比如一个参数的是操作本身<br>两个的话第二个会收到第一个的返回值</li>
<li>waitif和thenif的最大区别时wait的实现是异步的，而then是需要等待的（同步的），我看代码的时候没有特别在意这一点，可以回过头来最后研究一下同步和异步的关系，最后补充进笔记中。<br>我又重新看了一遍executor,感觉非常奇怪，既然写了wait，那么应该是要等待前面的那个执行完成的。<br>所以这里的异步大概可以理解为都是注册了回调的future，然后异步的和其他的东西一起跑，比如说场景和角色、怪物等等。跑到需要同步的地方就会等待前面的异步都执行完，然后进入队列最后再扔回异步里，当然这个过程应该是放在vertx里的，我回头问一下苏老师我这样的理解是不是正确的吧。</li>
<li><del>经验总结的话，失败是Future.succeededFuture()，有点…有点奇怪。</del></li>
<li>recover是直接变化前面的future状态！！懂了吗，前面的状态！因为可以获得一个cause，所以在特定的Exception的情况下，可以交给logger让他记录一下，future改成一个succeededFuture，如果没有记录就是正常跳出，仍然变成一个failedFuture！<br>这是个特性，可以用来跳过一些判断，比如有一个「如果登陆失败，应当作无事发生」，就可以logger一下，但是仍旧当作succeed继续跑。</li>
<li>所有accountProvider.xxx()的操作都是数据库操作。</li>
<li>有一说一，很多函数（方法）大量出现，要找到规律（即用法）和不太相同的注释。有一点问题是我每次都不写接口或者类，只写调用的方法名，其实有些难理解的，比如上一条tip提到的，如果写出来的话会好很多。<br>//TODO+1</li>
<li>fireAndForget:发后即忘，发送方和接收方彼此隔离。不会阻塞地等待消息</li>
</ul>
<hr>
<h1 id="auth"><a href="#auth" class="headerlink" title="auth"></a>auth</h1><h2 id="authAnonymous"><a href="#authAnonymous" class="headerlink" title="authAnonymous"></a>authAnonymous</h2><p>第一个中函数，create a session在服务器上或者创建一个新的账号，这个账号还会和B.net账号link。<br>首先都在Executorfatory上做</p>
<ul>
<li>先验证error各种null/empty的情况</li>
<li>找到账号。若无则创建一个，创建用createAnonymousAccount</li>
<li>检验该账号是否被ban</li>
<li>若无B.net账号，创建一个(匿名anonymous的)<ul>
<li>检查一下创建的sessiondetail，然后加进ctx里，顺便给ctx里的account赋一下这个bnetA</li>
</ul>
</li>
<li>更新账号link(link,devices)</li>
<li>更新gld版本</li>
<li>生成session</li>
<li>//==sujun==//session存到redis中<ul>
<li>用sessionprovider.saveSession，需要把session转为SessionCacheInfo</li>
</ul>
</li>
<li>run()</li>
</ul>
<h2 id="authFirstParty"><a href="#authFirstParty" class="headerlink" title="authFirstParty"></a>authFirstParty</h2><p>出现了不认识的authFirstParty</p>
<p>然后这个throws好恐怖啊<br>我就是想知道这个validate到底是确定什么jb的。</p>
<p>auth+GameCenter/GooglePlay/Gplus/Kakao/Nintendo<br>都用到了authFirstParty，长得都一样，用到函数的参数不太一样，后面提。</p>
<p>link+GameCenter/GooglePlay/Nintendo<br>用linkFirstParty，在自己信息的基础上，还要3个String bnet账号/密码/登陆token<br>作用是link a user with credentials</p>
<p>linkBnet不同，是用linkBnetMasterAccount，还要带gamesenter/googleplay/nintendo的参数</p>
<p>linkForce+GameCenter/GooglePlay/Nintendo<br>用linkForceFirstParty，同上</p>
<p>linkForceBnet同上，多两个异常判定</p>
<p>Force：发生冲突时，通过将账号与提供的用户id关联解决。<br>与第一方关联的所有外部账户从源账号转移到目标账号<br>Bnet account 和 两个blades account link，解决了选择账号</p>
<hr>
<h2 id="refershToken"><a href="#refershToken" class="headerlink" title="refershToken"></a>refershToken</h2><p>ExecutorFactory起手。<br>userinfo gldversion判断空<br>token必须经过2/3的生命周期才可以refresh，容易倒推得：tokenExpirationSeconds是应当死亡的时间（token到期时间） - 1/3 * 已经存活的时间 &lt; 当前时间，则报错too soon（说明还没到2/3存活时间）<br>accountProvider.requireAccount，扔给ctx（上面也有过，就是找到账号）<br>处理账号link问题<br>获取Bnet权力，避免一直refresh而获得不到的情况<br>更新ban状态<br>更新gldversion</p>
<p>refreshSession，注意<br>生成session如果gld是新的,避免token带有旧版本gld<br>//==sujun==<br>session存到redis</p>
<hr>
<h2 id="createAnonymousAccount"><a href="#createAnonymousAccount" class="headerlink" title="createAnonymousAccount"></a>createAnonymousAccount</h2><p>创建一个匿名Blades账号。会创建一个匿名B.net账号然后link到blades账号上</p>
<p>好，爷又不会了。就离谱，我才反应过来这里的大部分东西都是接口变量，那他到底用谁的实现呢。<br>上面根本找不到就离谱。<br>上面找到的是ctx，ctx就算资源的一种了，那再想知道是谁在调用根本就是天方夜谭，怎么会有这种设计<br>我再想想。<br>可能就是不想让人知道是谁在调用吧，很成功.jpg。用的人必须注意不能用错。<br>这里有一个奇异的设计，就是用list来存某一个数据，对，是一个数据。叫ExternalAccountId</p>
<p>fireAndForget现存的用到的地方有些有限，存疑。</p>
<hr>
<h2 id="tryCreateAnonymousBnetAccount"><a href="#tryCreateAnonymousBnetAccount" class="headerlink" title="tryCreateAnonymousBnetAccount"></a>tryCreateAnonymousBnetAccount</h2><p>试图创建匿名Bnet账号<br>调用CreateAnonymousAccount函数<br>这里问题又来了。<br>还是一样的该死的问题，为什么用接口变量.函数?那么用的到底是哪个函数？<br>懂了，全都是在初始化的时候干的，这就是接口的用处了。根据初始化时候使用的变量来调用。</p>
<p><del>里面有个future.recover，文档写的是「返回另一个future的结果来处理这个future的失败」，里面是出错(logger.error)的时候返回了succeededFuture(null)，外面用的是e-&gt;Future.failedFuture(e),老实说，存疑吧。</del><br>（后面注释是失败也当无事发生，意思就是创建会做，控制一下返回值。<br>懂了，写在tip了。</p>
<hr>
<p>很关键，被苏老师强调的函数。<br>FirstParty翻译待定/甲方、第一方/首次参与（大概率前者），这里用第一方翻译。</p>
<h2 id="authFirstParty-1"><a href="#authFirstParty-1" class="headerlink" title="authFirstParty"></a>authFirstParty</h2><pre><code>在由第一方凭据标识的用户的后端服务上创建会话</code></pre><p>直接executorfactory</p>
<ul>
<li>先确认error</li>
<li>waitfor Validate signin details</li>
<li>waitfor 取blade账号(account),用associated的第一方账号<ul>
<li>从ctx中取出externalAccountId(用一个waitfor赋给后面的操作)<ul>
<li>用id检查账号不存在/创建被禁止 跳error</li>
<li>account放进ctx</li>
<li>//===add By Sujun<br>区分账号的类型是Gplus还是kakao（否则设空？）</li>
</ul>
</li>
</ul>
</li>
<li>waitif 处理账号link问题</li>
<li>waitif 处理ban问题</li>
<li>waitfor 登陆BNET账号，失败也当无事发生(这里就是recover,控制一下返回值)</li>
<li>如果找不到account，尝试通过master buid找到ExternalAccountId(bnetid)，反向找到account(如果存在这样的联系的话，即第一方凭据绑定bnet master buid，这个id绑定一个存在的account)，注意到取不出来(没有这种联系)或者登陆失败都会返回一个Future.succeededFuture()<br>这里没有做处理，我感到奇怪。</li>
<li>3 * waitfor 更新账号状态（创建如果需要(应该就是之前的处理了),更新link，更新devices</li>
<li>2 * waitfor 获取权限（获取Bnet权力），增加ea资格:master account(tryUpdateAccountEntitlement)、early access</li>
<li>waitfor 更新gld</li>
<li>//===Modified by sujun sessioncache更新</li>
</ul>
<hr>
<p>吐槽:怎么函数变得一个比一个长了…</p>
<hr>
<h2 id="tryProvideReceiptEarlyAccess"><a href="#tryProvideReceiptEarlyAccess" class="headerlink" title="tryProvideReceiptEarlyAccess"></a>tryProvideReceiptEarlyAccess</h2><p>提供early access entitlement基于receipt（订单)</p>
<ul>
<li>确认有ios receipt且处于gating</li>
<li>ExecutorFactory启动</li>
<li>waitif get entitlements associate to account(如果玩家无master且无联系)</li>
</ul>
<p>以下大量recover警告！</p>
<ul>
<li>waitfor get 绑定在receipt的下载id<ul>
<li>如果已经有了gating early accss,无需check，return succeedFuture(new AppleDownloadIDResult(null,false))</li>
<li>否则用appleReceiptProvider.getDownloadId(receipt).recover，后面就是神奇的recover</li>
<li>我懂了，就是如果是服务器请求Apple问题的话，当作无事发生继续运行。</li>
</ul>
</li>
<li>waitfor 检查备用终点(if needed)<ul>
<li>checkEndPoint</li>
<li>Logger记录一下receipt第一部分(长度11)</li>
<li>recover getDownloadId备用host是否连通</li>
</ul>
</li>
<li>waitfor 如果找到有效的未分配gate，给user entitlement<ul>
<li>如果gate有user了，就不给。如果空闲但是不匹配就是hack行为，不给</li>
<li>注意给account新增entitlementId的方式和格式，给完了recover一下。</li>
</ul>
</li>
<li>waitfor 如果entitlement给出了，更新gate并绑定相应user<ul>
<li>更新gate注意方式。最后save一下，带recover</li>
</ul>
</li>
</ul>
<hr>
<h2 id="linkFirstParty"><a href="#linkFirstParty" class="headerlink" title="linkFirstParty"></a>linkFirstParty</h2><p>将第一方或B.NET主帐户与经过身份验证的用户相关联。<br>凭证可能已经与另一个Blades帐户相关联。 在这种情况下，将返回冲突以及两个帐户的用户ID。<br>如果未检测到冲突，则将帐户链接在一起（blades服务器帐户和B.NET帐户），并返回合并帐户的会话。</p>
<p>ExecutorFactory启动</p>
<ul>
<li><p>validate * 3 确认一波信息</p>
</li>
<li><p>waitfor 确认登陆细节</p>
</li>
<li><p>waitfor 检查有无冲突问题。先用函数查到冲突的账号，id加进accountLinkresult中</p>
</li>
<li><p>waitfor fixBnetAccountStatus（检查账号link问题</p>
</li>
<li><p>waitif 无冲突，新的一层ExecutorFactory</p>
<ul>
<li><p>waitfor 取account、ExternalAccountId，向前者add audit note，saveAccount</p>
</li>
<li><p>waitfor 获取bnet session token</p>
<ul>
<li>第一个参数内:</li>
<li>取account，如果玩家现在有一个bnet<strong>匿名</strong>账号，设bnetSessionDetailsFuture为bnetAccountProvider.authAnonymous()</li>
<li>如果有一个bnet FULL_ACCOUNT，用账号密码，就用账号密码通过，空bnetLoginToken就bnetAccountProvider.loginGameAccount，否则.auth</li>
<li>bnet account是no_account/GAME_ACCOUNT则无link必要，session remain null(succeededFuture())</li>
<li>返回bnetSessionDetailsFuture.recover</li>
<li>第二个参数内:</li>
<li>验证参数中传递的凭据是否与当前经过身份验证的帐户（currentMasterBuid）相同的Bnet帐户。用Account.findExternalAccountId()和bnetSessionDetails.getMasterAccountBuid()</li>
</ul>
</li>
<li><p>waitif 用external account credentials登入Bnet game account，if gameAccountLoginexecutor!=null，.run().recover()即可</p>
</li>
<li><p>then 确认第一方账号没有link到不同的bnet master account中。<br>事实上就是用当前ctx中的BnetSessionDeatils(中间轴件)与取出来的Account.findExternalAccountId的Master accountbuidid比对一下。</p>
</li>
<li><p>waitif <strong>link game account if required</strong>.总是required，不过bnet不允许link匿名account into game account，另外可能因为服务失败一直无法创建bnet</p>
<ul>
<li><p>if 检查各项需要的:selected_session_details,!isBnetAnonymous(),BnetSessionDetails,getMasterAccountBuid</p>
</li>
<li><p>selectedSessionToken=((BnetSessionDetails) ctx.getData(SELECTED_SESSION_DETAILS)).getSessionToken</p>
</li>
<li><p>rejectedSessionToken=BnetSessionDetails.getSessionToken</p>
</li>
<li><p>linkResolveGameAccount(Link a game account with a master account. Force keep the game account identified by the selected session token.)</p>
</li>
<li><p>最后保存session details</p>
<p><del>如果你仔细看，就知道这里就有了SELECTED_SESSION_DETAILS和bnetsessiondetail的区别了,hhh</del></p>
</li>
</ul>
</li>
<li><p>then <strong>add audit note确认账号已link，更新bnet account state</strong></p>
</li>
<li><p>waitfor <strong>Commit link to Blades account提交link</strong> updateAccountLink（这里很奇怪，因为经验是之前都会绑定和device一起update）</p>
</li>
<li><p>waitfor <strong>Get entitlements from BNET (works only if user has master account)</strong> BnetAccountManager.tryUpdateAccountEntitlement（即获取权限，或者说获取Bnet权力）</p>
</li>
<li><p>waitif <strong>Refresh刷新 the login token</strong> bnetAccountProvider.getLoginToken</p>
</li>
<li><p>then <strong>generate生成 session</strong> authenticationHandler.generateSession;accountLinkResult.setSession(session);accountLinkResult.setLoginToken(loginToken);</p>
</li>
</ul>
</li>
<li><p>then ()-&gt; accountLinkResult</p>
</li>
<li><p>run()<br>(后面主要是调用不同的接口了，没有什么很迷惑的地方，我就直接贴了。)</p>
</li>
</ul>
<hr>
<h2 id="linkBnetMasterAccount"><a href="#linkBnetMasterAccount" class="headerlink" title="linkBnetMasterAccount"></a>linkBnetMasterAccount</h2><p>link a master Bnet 账号和一个已认证过的用户。我们希望用户有一个game/anonymous account linked to blade account。<br>如果用户有第一方游戏账号，客户端提供第一方credentials以使我们获得游戏账号session token for linking resolve<br>可能credentials已经被另一个账号绑定，冲突会返回二者的id<br>无冲突就link，返回session。</p>
<p>斜体表示和上面不同的<br>BetAccountStatus有这几种：<br>NO_ACCOUNT：没有和blades account绑定的account<br>ANONYMOUS：blades account 和一个匿名B.NET account link<br>GAME_ACCOUNT：blades account和一个external(外部?)B.NET game account link<br>FULL_ACCOUNT：blades account和一个master B.NET account、一个或更多的game account link</p>
<p>ExecutorFactory启动</p>
<ul>
<li><p>validate * 3 确认一波信息</p>
</li>
<li><p>waitfor 确认登陆细节</p>
</li>
<li><p>waitfor <strong>检查有无冲突问题</strong>。先用函数查到冲突的账号，id加进accountLinkresult中</p>
</li>
<li><p><em>wait if <strong>如果冲突，set login token</strong> bnetAccountProvider.getLoginToken().recover()</em></p>
</li>
<li><p>waitfor fixbnetAccountstatus</p>
</li>
<li><p>waitif 无冲突，新的一层ExecutorFactory</p>
<ul>
<li><p>waitfor 取account、ExternalAccountId，向前者add audit note，saveAccount</p>
</li>
<li><p>waitfor 获取bnet session token</p>
<ul>
<li><p>第一个参数内：<em>直接返回，无需用bnetsessiondetailfuture做recover</em></p>
</li>
<li><p>取account，如果现在有一个bnet匿名账号，return .authAnonymous</p>
</li>
<li><p><em>如果是一个game_ACCOUNT，则按传进来的平台扔loginGameAccount()</em></p>
</li>
<li><p>其他情况均succeededFuture，<del>值得一提的是，这里的注释和之前一样，但是实际代码有些区别。</del>后面的注释就正确了。</p>
</li>
<li><p>第二个参数内：</p>
</li>
<li><p><em>这里直接赋值给了selected_session_details，没有其他的任何操作。而linkFirstParty却是先判定null，中间还有个throw，最后才赋值。</em></p>
</li>
</ul>
</li>
<li><p>waitif <strong>link game account if required，仅当user当前有master account时运行</strong> <em>区别是没有recover</em></p>
</li>
<li><p>then <strong>add audit note确认账号已link，更新bnet account state</strong> 完全一致</p>
</li>
<li><p>waitfor <strong>Commit link to Blades account提交link</strong> 完全一致</p>
</li>
<li><p>waitfor <strong>Get entitlements from BNET (works only if user has master account)</strong>  完全一致</p>
</li>
<li><p>waitfor <strong>由于可能更改了session details，需要generate 新的login token</strong> getLoginToken.recover</p>
</li>
</ul>
<p>  <em>区别：不用ctx里的selected_session_details，而是用ctx的bnetsessiondetails</em> 老实说我不知道搞这种活有什么用</p>
<ul>
<li><strong>generate session</strong> 完全一致</li>
<li>run</li>
</ul>
</li>
<li><p>then ()-&gt;accountLinkResult</p>
</li>
<li><p>run</p>
</li>
</ul>
<hr>
<h2 id="linkForceFirstParty"><a href="#linkForceFirstParty" class="headerlink" title="linkForceFirstParty"></a>linkForceFirstParty</h2><p>将给的用户和外部账号link。发生冲突时，通过将账号与提供的用户id关联解决。<br>与第一方关联的所有外部账户从源账号转移到目标账号<br>Bnet account 和 两个blades account link，解决了选择账号</p>
<p>ExecutorFactory启动</p>
<ul>
<li>validate * 3</li>
<li>then <strong>一个可用的buid required to perform a first party link</strong> validateBuid(userInfo)</li>
<li>waitfor <strong>Validate signin details</strong></li>
<li>waitfor <strong>检查冲突问题</strong> <em>不同之处在于这里如果没有冲突账号会throw error”FIRST_PARTY_LINK_NO_RESOLVE_REQUIRED”，否则存下冲突账号</em></li>
<li>waitfor fixbnetAccountstatus</li>
<li>waitfor <strong>获取bnet session token</strong> 这里和linkFirstParty几乎一模一样，区别是<em>当遇到no_account/game_account时， “throw an error as these are invalid states”</em></li>
<li>waitif <strong>登入BNET游戏账号if using 第一方credentials</strong> gameAccountLoginExecutor.run</li>
<li>then <strong>接上</strong> accountForceLinkHandler.setup 第一个参数是target，第三个是source。初始化就是第一个用ctxAccount，第三个用刚才存下的冲突Account</li>
<li>waitfor * 2 <strong>save audit notes to both accounts</strong> saveAccount把刚才那俩都给存起来</li>
<li>waitfor <strong>把source的account links转移到target中</strong> transferExternalAccounts()，后面遍历link挨个存到数据库里</li>
<li>waitif <strong>Link B.NET accounts if required</strong> if shouldlink，linkResolveGameAccount.这里的link和正常的link区别是判断特别少，取双token也是从目标和源各取一个sessiontoken，建议自己对比一下。</li>
<li>waitfor * 2 又更新一遍数据库….”<strong>Save our updated accounts in Dynamo DB now that the B.NET account has passed</strong>“</li>
<li>waitfor <strong>Get entitlements from BNET</strong> target的，其他一致</li>
<li>waitfor <strong>Update the gld version of target(kept) account with the source(ditched) account’s GLD version if it is newer</strong> 说白了用目标往源里更gld（注意顺序吧</li>
<li><strong>Refresh the login token</strong> 完全一致，这里就用的ctx了</li>
<li><strong>Generate session for selected account</strong> 如注释。</li>
</ul>
<hr>
<h2 id="linkForceBnetMasterAccount"><a href="#linkForceBnetMasterAccount" class="headerlink" title="linkForceBnetMasterAccount"></a>linkForceBnetMasterAccount</h2><p>找茬开始了</p>
<p>这里就不写流程了，直接找不同。</p>
<p>前面一样</p>
<ul>
<li><em>在get b.net session token的时候，如果获取到的是game——account，3检查。最后如果是full、no则throw</em></li>
<li><em>不需要gameAccountLoginExecutor.run()</em></li>
<li>transfer都一样，之后就出现了区别<em>会存了之后再link bnet，而之前是先link再存</em></li>
<li><em>refresh the login token的时候没有判断，不是用SELECT而是用ctx.BnetSessionDetails</em>注释写道:<strong><em>Since we might have changed our session details we need to generate a new login token</em></strong>这里倒是跟之前那个一样。</li>
</ul>
<hr>
<p>fixBnetAccountStatus<br><strong>此方法处理account验证是否时可用的bnet state，fix it if necessary</strong></p>
<ul>
<li>取externalAccountId(betn_master_account)</li>
<li>检查BnetAccountStatus.GAME_ACCOUNT是否等同于account.getBnetAccountStatus且有externalAccountId<ul>
<li>如果等于，就说明是FULL_ACCOUNT，account.set，.addaduitnote。</li>
<li>return accountProvider.saveAccount</li>
</ul>
</li>
<li>return succeededFuture(account)</li>
</ul>
<hr>
<p>checkLinkingConflictOrProblems</p>
<p>ExecutorFactor.create()</p>
<ul>
<li>waitFor()</li>
<li>waitFor()</li>
<li>then<br>欠债ing</li>
</ul>
<hr>
<p>苏老师可真是出了个大难题<br>看Executor的代码<br>Executor通常由空Factory进行动作，实际由实现了Executor这个接口的BaseExecutor进行动作。<br>其中，通过一个<code>List&lt;ExecutorStep&lt;?&gt;&gt;stepList</code>进行步骤安排。ExecutorStep是实现了Validatable的抽象类，自带一个<code>&lt;TResult&gt;</code>作为这个步骤返回值的类型，核心是apply，意义是执行当前步骤或以前一步骤的值作为参数执行当前步骤。代码逻辑的核心是给previous.setHandler<br>.setHandler:<br>失败则给当前future继承fail(p.cause())，成功则用抽象方法apply = executeStep(previous)，trycatch一下，然后把当前的future绑定到apply上。<br>返回当前future</p>
<p>核心就是executeStep，有多种实现，分别对应比如链步骤、等待步骤等6种。</p>
<p>说白了就是在每两个Future中间插进一个apply来完成不同种类的Executor动作，比如Waitif。即使只有一个要插在前面一个apply。<br>以waitstep的实现举例，给定previous(就是当前future)，若无waitstep建立一个TPrevious变量，其值为previous.result()，返回waitStepWithPrevious执行此值，否则执行waitstep<br>推翻了我的结论，令我感到困惑。且不管‘异步步骤’这个类，为什么作为.sethandler(a)，a是previous？明明handler后面是要等待前面的future完成后才会跑的。<br>回过头看BaseExecutor的run过程，发现先给出chainIterator，while next,nexeStep=Iterator.next()，尝试确定可行性后就是current=nextStep.apply(current),current=null就直接apply。</p>
<p>这样就好了，无参数即run序列的Chain中第一个，执行的是executeStep(null).<br>make sense。即apply执行一个null的future(虽然不知道能不能，能跑就行.jpg)跑完了就可以直接跑第一个序列了。<br>第二个时，第一个和第二个是相关联的，此时apply是executeStep(previous)，即取的第一个执行完的future的future，第一个跑完了、完成了apply，就可以跑第二个了。刚才困惑是以为executeStep里绑定的是当前future。</p>
<p>有了上述内容就可以看waitif、waitfor和then了<br>双参数和三参数本质没有区别，三参数执行WaitWithCallbackStep，双参数执行WaitStep<br>waitif(condition,operation):新建变量<code>stepToexecute=new WaitStep&lt;Void,Tresult&gt;(opertion)</code>,waitStepWithPrevious = opertion<br>stepList里add <code>ConditionalStep&lt;TResult&gt;(condition, stepToExecute)</code></p>
<p>然后其实ExecutorStep是用不到的，用到的是它的子类的子类们。比如第一层子类BaseConditionalStep，第二层ConditionalStep，其核心逻辑很简单，super(condition),this.step = step.第一层则会用不同的方法实现executeStep，先检查condition，如果有则先执行condition，然后根据这个bool判断是否执行下一步。注意即使是条件没过，也可以继续执行。</p>
<p>嵌套层数过多，需要画图。</p>
<p>不过我已经懂了。现在来看.then<br>我们需要的是带previous的版本，ChainStep。现在我们有前面一个future和当前的future，现在run。<br>由于apply只是个外部的临时变量，所以不会在list里面，current就是之前的里的，nextStep就是.then。<del>先给出前面的值，.result()，result作为结果量，.complete(连带着参数从.then传进来的（之前的值）作为参数跑，</del>注意nextStep用的是ExecutorStep，所以要用对应的apply，当然，会用对应的executeStep。<br>给前面的future.setHandler()，中间量apply是executeStep执行出参数的future值，<del>apply执行完就可以跑当前的future啦。</del><br>apply根本就不是什么中间量，而是用当前future的结果执行下一个Step的future！于是说ret才是个空值，那么有人会问为什么return ret？</p>
<p>我也不懂啊！断点走起来</p>
<p>懂了 大佬给future都重写了一遍，绑定了mdcHolder，你看到的那个就是默认的空future，</p>
<p>setHandler也改过了，经过一番难以言喻的函数，本来里面是个{Future{unsolve}} 就变成了 {Future{result=null}}</p>
<p>正常的经过sethandler就可以变成result=null，而且也会走正常流程，sb的就直接过去了，step into进不去我人傻了。</p>
<p>进去了，走waitstep</p>
<hr>
<p>以下用到provider用p.代替，用到detailsprovider用dp.代替<br>Guild用G代替<br>Details用D代替<br>Cache=Ca<br>And=A<br>update=u<br>guild=g<br>response=res<br>require=req<br>Member=Mem<br>Message=mes<br>master=mas<br>Characters=Ch<br>Collection=Co<br>validate = v<br>Applications=App</p>
<p>GP是连接bnet/snqu<br>而GDP是连接数据库的<br>applications - 申请<br>response分有无current两种<br>有current：Details、members、application<br>response的组成:details、members、是否超出最大申请数</p>
<p>Guild - Controller<br>很明显的可以感受出来，这边就是把各种方法结合在一起实现某种功能，大部分接口都是Provider或者什么实现出来的。</p>
<ul>
<li>getGuild 用提供的guildID</li>
</ul>
<ul>
<li>p.requireGuild() 取得工会</li>
<li>getGMemWithUserIds 添加成员</li>
<li>p.getApplicationCount</li>
<li>dp.getGuildDetails</li>
<li>GuildResponse()</li>
</ul>
<p>getCurrentGuild<br><strong>如果玩家在guild里就返回公会成员列表，否则返回此玩家的公会申请//如果被ban了，则返回一个APPLIED的申请但是对工会不可见</strong></p>
<ul>
<li>p.getCurrentGuild</li>
<li>dp.getGuildDetails</li>
<li>取得成员</li>
<li><strong>如果找到了guild，立刻创建guild response</strong></li>
<li><strong>如果找到，检查此玩家是否有申请</strong> gP.getCurrentGApp()<ul>
<li>无申请，response设一下</li>
<li>有，还大于1，warn一下，返回第一个</li>
</ul>
</li>
</ul>
<p>updateGDACa<br>尝试在DB中对GD进行多次读-更新-写操作,用的操作很奇怪，FutureUtils.executeWithRetries(,gdp.uGD,responseRef::set)<br>gP.uGDCa</p>
<p>leaveG</p>
<ul>
<li>判断是否为Grandmaster</li>
<li><strong>获取玩家的rank</strong>reqGMem</li>
<li><strong>保证guild PVP score更新完成，Grandmaster影响这个更新</strong></li>
<li><strong>给Grandmaster找下家</strong></li>
<li>gMesBoardP.postMes()</li>
<li>deleteUserGExchanges</li>
</ul>
<p>grandMasLeaveG</p>
<ul>
<li>会内无人</li>
<li>会内仅1人候选</li>
<li>会内好多人候选</li>
<li>getGMemWithUserIds()-&gt; addall(),找到所有等级最高的成员</li>
<li><strong>如果会内无人，则删掉guild，不过不删掉guild message board，方便可能的会话</strong></li>
<li>一人直接给</li>
<li>多人，找到pvp奖励最多的人中资历最老的成员</li>
<li>给此人权限，让原会长leave。</li>
</ul>
<p>uGrandmasSince<br><strong>更新会长任命时间戳</strong></p>
<p>uGpvpTrophiesOnGmLeave<br><strong>保证guild pvp score更新完成。和grandmas时间戳</strong><br>与上面的区别在于会取一个gpvpT…handler.removeGMem</p>
<p>uGpvpT…Onleave<br>与上面的区别是不需要更新会长任命时间戳</p>
<p>getGMemWithUserIds</p>
<ul>
<li>gP.getGMem</li>
<li><strong>bnet 返回只含buid，我们必须加进userid</strong>     aP.getAIds()</li>
<li>通过map映射添加</li>
</ul>
<p>deleteuserGExchanges<br><strong>删除guild exchanges(交流?交换?交易?)</strong></p>
<ul>
<li>cP.getCh</li>
<li>为该玩家的每个角色都删掉GExchanges</li>
</ul>
<p>searchG</p>
<ul>
<li>gSearch.setLimitMax</li>
<li>gSearch.setNameATagWithSeparator(?)</li>
<li><strong>这是唯一用到BNET中的guildDetails的地方，其他的都用数据库的内容。（存在缓存主要是为了允许对其字段进行自定义字段搜索，但是可以在搜索结果中显示它）</strong> gP.searchG</li>
<li>GCoRes</li>
</ul>
<p>kickUser<br><strong>封装了从系统中踢出一个用户，增加了目标buid不正确时恢复的功能</strong></p>
<ul>
<li>Function = gP.deleteGMem</li>
<li>执行动作with成员解决方法(?)</li>
</ul>
<p>banUser<br><strong>封装了从系统中ban一个用户，增加了目标buid不正确时恢复的功能</strong><br>与上者不同的就是gP.banUser</p>
<p>vUGReq<br><strong>确认更新guild的request</strong><br><em>放一放，一会看</em><br>先看request类型是否是AdminUGReq，不是的话就要后面做侮辱性语言检查，称做亵渎检查<br>确认guild 名称、短描述和长描述问题<br>…亵渎检查长短描述。</p>
<p>getGMemSlotsLeft<br><strong>G中还能加入多少成员(插槽)</strong></p>
<ul>
<li>guildGLD.getMaxMem-gP.getGMemCount</li>
</ul>
<p>getGGrandMasUserInfo<br><strong>检索会长的玩家信息</strong><br>取buid、通过buid取得account，然后validate一下，就可以返回了</p>
<p>generateTagId<br><strong>给提供的公会名生成TagId</strong><br>这里用到TagIdGenerator，看着参数搞就行</p>
<p>approveAsManyApplicationsAsPossible<br><strong>就跟名字一模一样的用处（</strong><br>逻辑很简单。getGApplicationsWithUserIds,getGMemSlotsLeft,然后根据申请日期给申请排序，遍历所有申请每次容量-1，如果无位置剩余就拒绝申请，有就接受，注意每次接受与否都会做两个动作:<br>gP.approve/denyApplication<br>gMesBoardP.postMes()</p>
<p>拒绝所有申请<br>就这么简单，比起上面不需要容量的限制，只需要遍历即可。</p>
<p>getGApplicationsWithUserIds<br><strong>检索该工会的所有申请</strong></p>
<ul>
<li>gP.getGApp</li>
<li>aP.getAccountIds</li>
<li>GAppCoRes.updateUserIds()</li>
</ul>
<p>reqFirstCh<br><strong>req 一个玩家的角色列表，返回第一个。</strong><br><em>Guild support only one character per user currently</em> <del>存疑，这里之后问一下苏老师</del> 问过了，一个user只有一个character</p>
<p>uAppOnTypeU<br><strong>依赖公会type更新申请</strong><br>type:开放、需要申请、关闭<br>如果之前需要申请，之后开放/关闭，按对应方式处理所有申请即可</p>
<p>执行动作with成员解决方法<br><strong>这个是用来解决这样一个问题的：匿名用户加入到公会中，升级到第一方后其”匿名buid”会转化为”game buid”，但是公会仍然引用匿名buid，但是很多操作因为系统使用ganmebuid而会失败。此方法通过从bnet检索行会成员列表来匹配其userid来进行用户的反向查找，而不是依赖于用户账户上的buid(第一方buid)来进行禁止/踢动作的正常工作。</strong></p>
<ul>
<li>注意recover可以用来做恢复</li>
<li>整体逻辑看下来，只有做recover的时候，才会用到这个反向查找。<br>这里稍稍存疑。</li>
</ul>
<p>Controller=C<br>GMan:<br>getCurrentG<br>return gC.getCurrentG</p>
<p>getG<br>validate之后gC.getG</p>
<p>createG</p>
<ul>
<li>validate非法</li>
<li>取徽章icon，取地区</li>
<li>确认名称、长短描述的长短、codepoint有无错</li>
<li>如果需要仓库，存取一下仓库。取下钱包</li>
<li>pay一下</li>
<li>亵渎检查（wtf，为什么先支付再亵渎检查，也无妨，后面才更新</li>
<li>生成tag,gC.generateTagId</li>
<li>取得角色</li>
<li>业务验证(角色是否有资格进入公会)</li>
<li>remove该玩家的所有guild申请</li>
<li>创建guild//sujun添加区域参数<ul>
<li>uGDOnCreateG</li>
<li>更新仓库钱包</li>
</ul>
</li>
<li>return 这个guild</li>
</ul>
<p>看完这个我觉得一个东西迫在眉睫，就是什么是character，什么是user。</p>
<hr>
<p>character</p>
<p>苏老师nb啊，每个character只有一个user（说反了）<br>说得通说得通。<br>这样很多逻辑就很显然，甚至非常容易了。</p>
<hr>
<p>uG</p>
<ul>
<li>validate参数非法</li>
<li><strong>需要获取当前guild来得到guildid、gmesboard的准备信息</strong><ul>
<li>gP.reqCurrentG 此时有oldGuild和update的req</li>
<li>gC.uAppOnTypeU (就是根据type更新申请)</li>
</ul>
</li>
<li><strong>更新guild和其details，然后postmessage</strong><ul>
<li>gP.uGWithoutName</li>
<li>uGDOnUG</li>
<li>gMesBoardP.postMes()</li>
</ul>
</li>
<li>return ugRes</li>
</ul>
<p>leaveG</p>
<ul>
<li>validate</li>
<li>gP.reqCurrentG</li>
<li>gC.leaveG</li>
</ul>
<p>kickGMem<br>逻辑就是</p>
<ul>
<li>取一堆信息:gP.reqCurrentG,gC.reqFirstCh,aP.getAccount</li>
<li>gC.kickUser()</li>
<li><strong>fireAndForget of 公会pvp分数update，使其不会干扰当前call</strong> fireAForget</li>
<li>gMesBoardP.postMes</li>
<li>gC.deleteUserGExchanges</li>
</ul>
<p>banUser()<br>改中间函数即可</p>
<p>searchG<br>validate后gC.searchG</p>
<p>getGApp<br>validate,gP.reqCurrentG,gC.getGAppWithUserIds()</p>
<p>joinG<br><strong>加入不需要申请的公会</strong></p>
<ul>
<li>validate</li>
<li>cP.getCh</li>
<li>检查加入的公会是否存在(名字如此，检查的却是最大值)</li>
<li><strong>remove该玩家的所有申请</strong></li>
<li>gP.joinG()</li>
<li>fireAForgetUGPvpTrophiesOnJoin</li>
<li>gMesBoardP.postMes</li>
</ul>
<p>applyG<br><strong>注意申请也是有上限的</strong></p>
<ul>
<li>validate</li>
<li>cP.getCh</li>
<li>gP.getGAppCount</li>
<li>确认最大值</li>
<li><strong>reomve该玩家所有申请</strong></li>
<li>gP.applyG</li>
<li>aP.getAccount</li>
<li>app.setUserId</li>
<li>return net GAppRes(app)</li>
</ul>
<hr>
<p>approveApp</p>
<ul>
<li>validate+三连(gP,aP,gC取当前G，当前Account，Ch)</li>
<li><strong>取出还有多少空位(slots)</strong><br>gC.getGMemSlotsLeft</li>
<li><strong>如果无空位此时denyall</strong></li>
<li>gP.approveApp</li>
<li>fireAndForgetUGPvp…</li>
<li><strong>post 批准</strong></li>
<li><strong>批了之后满员也denyall</strong></li>
<li>response</li>
</ul>
<hr>
<p>denyApp<br>欠债ing</p>
<hr>
<p>明日规划：inventory-market-fulfillment-<del>globalshop</del>-characterManager-<del>shop</del><br>建议先看shop</p>
<p>关于guild-s2s</p>
<hr>
<p>今天我必整理格式</p>
<hr>
<h1 id="shop"><a href="#shop" class="headerlink" title="shop"></a>shop</h1><h2 id="缩写"><a href="#缩写" class="headerlink" title="缩写"></a>缩写</h2><p>Speical = Sp(sP=shop provider)<br>get = get<br>generation/generate = g<br>Shop = S<br>character = ch<br>catalogs = ca<br>Handler = H<br>Response = Res<br>request = req<br>Provicder = P<br>Purchase = Pur<br>invnetory = i<br>wallet = w</p>
<h2 id="各项内容含义"><a href="#各项内容含义" class="headerlink" title="各项内容含义"></a>各项内容含义</h2><h3 id="catalogs"><a href="#catalogs" class="headerlink" title="catalogs"></a>catalogs</h3><p>id,templateId,<br>bundles:catalogs包含的包的列表,经过确认，这里只包含数量，价格是在购买的时候从gld里获取的。<br>wallet:卖家用来买玩家的资源(?我怀疑写反了，就是玩家的各种资源和货币的类)<br>start,expirations:起止时间</p>
<h2 id="getSpS"><a href="#getSpS" class="headerlink" title="getSpS"></a>getSpS</h2><p><strong>取得sp shop，生成必需的catalogs</strong><br>用到:SpCaGH<br>chP,sP,caP</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><ul>
<li>validate参数</li>
<li>cP.getCh</li>
<li><strong>get sp S or create it</strong><br>sP.getSpS<ul>
<li>如果不存在 Sp.createDirty()</li>
</ul>
</li>
<li><strong>get all ca 当前与shop关联</strong><br>cP.getCa</li>
<li><strong>清理过期的ca</strong><br>SpCaGH.clean</li>
<li>生成新的sp offer ca<br>cP.createCa -&gt;<br>ca.addAll(),s.addCa()</li>
<li>SpSRes()</li>
</ul>
<hr>
<h2 id="getShop"><a href="#getShop" class="headerlink" title="getShop"></a>getShop</h2><p><strong>get 一个或者生成一个</strong><br>CommonH townH = new CommonH<br>buyback<br>CaGH  </p>
<h3 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h3><ul>
<li>区分需要生成ca和不需要生成且连接用户不是shop拥有者</li>
<li>sP.reqS,getBuybacks</li>
<li><strong>如果Ca不为null,取cP.getCa，否则说明shop刚刚被upgrade</strong><br>getCa,设一下Ca</li>
<li><strong>ca需要生成的场景：1.过期。2.build gets upgraded，town manager reset shop ca</strong><br>两种的话处理是类似的，都要用tP.reqTown取一下城镇设一下TownBuilding，cP.createCa，然后Shop.reset,Shop.setCaId,设一下Ca最后sP.uS</li>
<li>如果”不需要生成且连接用户不是shop拥有者”，sP.getS,用getOrCreateSocialContactSCopy覆盖Shop，注意购买执行之前不会创建数据库条目</li>
<li>SRes</li>
</ul>
<hr>
<h2 id="purSpBundle"><a href="#purSpBundle" class="headerlink" title="purSpBundle()"></a>purSpBundle()</h2><p>SpPurH<br>有个参数叫TownXP,有理由怀疑每个城镇有自己的经验。</p>
<h3 id="流程-2"><a href="#流程-2" class="headerlink" title="流程"></a>流程</h3><ul>
<li>validate参数</li>
<li><strong>取出对应内容，即每次get都会setData</strong><br>cP.getCh，iP.getI,wP.getW,sP.reqSpS,sP.reqS,caP.reqCa</li>
<li>检查isTownXPRewarded(是否有购买会奖励XP)，如果有则取出town，tP.reqT</li>
<li>SpPurH.purchase(刚才取粗后来的一堆参数)</li>
<li>后面不写了，就是把之前取出来的东西再存回去，基本上依然是Porvider的操作，无非就是sava、update这种操作。注意Town会用一个getTownRemovedProps，最后Response会用到，character有个dirty才save的判断</li>
<li>SpPurRes的参数就是刚才新存的那些。</li>
</ul>
<hr>
<h2 id="purB"><a href="#purB" class="headerlink" title="purB"></a>purB</h2><p>socialPur = shop不是你开的 或 shop不是你开的（user和ch双重判断）<br>PurH = PurH(用来判断玩家是否支出宝石)<br>…TownXP</p>
<ul>
<li>validate，取值同上</li>
<li>如果不是你开的shop，sP.getS,setData(Shop,getOrCreate…)</li>
<li><strong>Ca只会为shop owner存在，owner shop和connect的user shop 都 link to it</strong>  </li>
<li>PurH.pur(一堆参数)</li>
<li><em>与上面的区别在于没有saveSp,而是如果shop version==0,意味着我们只是创建了其他要pur的shop的copy，需要sP.createS</em></li>
<li>PurRes() <em>多一个socialPur</em></li>
</ul>
<hr>
<h2 id="getOrCreateSocialContactSCopy"><a href="#getOrCreateSocialContactSCopy" class="headerlink" title="getOrCreateSocialContactSCopy"></a>getOrCreateSocialContactSCopy</h2><ul>
<li>**如果connectedUserS存在且与ownerS有相同的Ca，（ownerS没过期且没被upgrade reset），返回connectUserS</li>
<li>否则用ownerS的sId和caId创建一个新的s</li>
</ul>
<hr>
<h2 id="sellItems"><a href="#sellItems" class="headerlink" title="sellItems"></a>sellItems</h2><p>SellH<br>buybacks</p>
<h3 id="流程-3"><a href="#流程-3" class="headerlink" title="流程"></a>流程</h3><ul>
<li>validate</li>
<li>取i,w,s,ca</li>
<li>SellH.process()(<strong>处理出售给商店的物品清单</strong>)</li>
<li>buybackP.createBuyBacks</li>
<li>更新w,s,i</li>
<li>SellRes</li>
</ul>
<hr>
<h2 id="buyback"><a href="#buyback" class="headerlink" title="buyback"></a>buyback</h2><ul>
<li>我都懒得写了…一模一样吧</li>
<li>最后会有一个buybackP.deleteBuyback</li>
</ul>
<hr>
<p>成了，下一个，<br>CaOverrideM-&gt;CaOverride-&gt;?<br>怎么就no usage了</p>
<p>下一个</p>
<h1 id="GSM"><a href="#GSM" class="headerlink" title="GSM"></a>GSM</h1><h2 id="缩写-1"><a href="#缩写-1" class="headerlink" title="缩写"></a>缩写</h2><p>Manager = M<br>Global = G<br>Generate = Gen<br>Shop = S<br>Handler<br>Provider<br>Purchase<br>Response<br>Override = O</p>
<h2 id="pur"><a href="#pur" class="headerlink" title="pur"></a>pur</h2><h3 id="流程-4"><a href="#流程-4" class="headerlink" title="流程"></a>流程</h3><p>好家伙，上来就看到了caOverrideP::getGSOverrides,可惜，遗憾，是P，那就跟那些没太有关系。</p>
<ul>
<li>如上，load 全局s overrides</li>
<li>用这个overrides<ul>
<li>getGLD取GSProductsCaGLD</li>
<li>搞一个Map，是用CaOH.getActiveGSPO建的</li>
<li>搞一个GSProduct = GSPurH.resolveProductO</li>
<li>GSPurH.validateActive</li>
<li>setData(GSProduct)</li>
<li>用每个用户是否最大判断mustSavePur</li>
<li>TownXp也给判断一下</li>
</ul>
</li>
<li>如果提供了期望的价格，那么如果不匹配实际价格则拒绝购买</li>
<li>取角色</li>
<li><strong>验证是否可以从临时商品中进行购买</strong> 函数不写了</li>
<li>如果必须购买 gSPurP.getGSPur,then,setData(GSPur),GSPurH.validateUserQ(确认没有购买到最大值)</li>
<li>取i,w,xp,GSPurH.purchase</li>
<li>存town,i,w,如果必须买，gSPurP给一个createOrUpdate(也是更新吧)</li>
<li>dirty就更新角色</li>
<li>GSPurH.buildPurRes</li>
</ul>
<h2 id="getPur"><a href="#getPur" class="headerlink" title="getPur"></a>getPur</h2><p><strong>获取全局shop购买为那些已经有用户最大(?)或者是执行奖励的角色</strong></p>
<ul>
<li>gSPurP.getGSPur</li>
<li><u> 用获得的purchases,new GSPurStatusRes </u></li>
</ul>
<h2 id="applyOfferLastChance"><a href="#applyOfferLastChance" class="headerlink" title="applyOfferLastChance"></a>applyOfferLastChance</h2><p><strong>更新全局商店offer以表明它已经显示了最后机会，并且将在最后机会持续时间之后过期</strong></p>
<ul>
<li>validate</li>
<li>取角色</li>
<li><u> GSLastChanceH.uOfferExpiryForLastChance()</u></li>
<li>如果offer改变，saveCh</li>
<li><u> new GSOfferLastChanceRes </u></li>
</ul>
<p>整理笔记的时候，setData的部分记得添加一下。<br>今天爷发现了盲点，then是同步的，其他都是异步的动作，也就是我写的有些顺序是可以随便执行的，但是有些不能，我回头要把不能的全都标出来。<br>这也是整理的时候要做的事情。<br>今天晚上就可以做。<br>必须做。</p>
<hr>
<h1 id="FulfillmentM"><a href="#FulfillmentM" class="headerlink" title="FulfillmentM"></a>FulfillmentM</h1><p>这个是整个支付的系统…pass，之后看。</p>
<h2 id="缩写-2"><a href="#缩写-2" class="headerlink" title="缩写"></a>缩写</h2><p>Fulfill = F<br>Manager<br>Inventory<br>Wallet<br>Global<br>Shop<br>Purchase<br>Provider<br>Response<br>Request<br>Queue<br>Internal = Int<br>Character<br>Receipt = R<br>Validate = V<br>Account = A<br>Gplus全拼</p>
<hr>
<h1 id="MarketManager"><a href="#MarketManager" class="headerlink" title="MarketManager"></a>MarketManager</h1><h2 id="缩写-3"><a href="#缩写-3" class="headerlink" title="缩写"></a>缩写</h2><p>Market = Mar<br>Manager = M<br>Fulfill = F<br>Manager<br>Inventory<br>Wallet<br>Global<br>Shop<br>Purchase<br>Provider<br>Response<br>Request<br>Queue<br>Internal = Int<br>Character<br>Receipt = R<br>Validate = V<br>Account = A<br>Offer = O<br>Town = T<br>create = c</p>
<h2 id="cO"><a href="#cO" class="headerlink" title="cO"></a>cO</h2><p>COH</p>
<h3 id="流程-5"><a href="#流程-5" class="headerlink" title="流程"></a>流程</h3><ul>
<li>v</li>
<li><strong>获取城镇等级，确认market可用</strong><br>这个动作是先通过P获取需要的那个东西，比如town,或者offer,然后-&gt;{cOH.sett/setActiveO;cOH.vMAvailability/vOCount}其实就是扔进H里然后看确认内容</li>
<li><strong>获取活跃的o,然后确认这里有空位可用</strong></li>
<li>iP.getI</li>
<li>oP.cO</li>
<li>iP.uI</li>
<li><u> CORes.create() </u></li>
</ul>
<hr>
<h2 id="cancelO"><a href="#cancelO" class="headerlink" title="cancelO"></a>cancelO</h2><ul>
<li>v</li>
<li>取O</li>
<li>删O</li>
<li>取I</li>
<li>准备且u i</li>
<li>return i u result to client</li>
</ul>
<hr>
<p>欠债ing</p>
<p>明日规划 challengeM characterM SocialChM FriendM<br>非常的容易，可以多来点:支付可以搞一下，然后如果有空就把这个Presence()看一下，反正很短，把短的都干掉就好了。能干多少干多少。</p>
<p><span style="border-bottom:2px dashed yellow;">所添加的需要加下划线的行内文字</span></p>
<hr>
<h1 id="ChallengeM"><a href="#ChallengeM" class="headerlink" title="ChallengeM"></a>ChallengeM</h1><h2 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h2><p><strong>取得当前challenge，必要时生成一个</strong></p>
<ul>
<li>v</li>
<li>cP.getCH,取得的ch用来做 ChallengeSeasonChH.uChallengeSeason</li>
<li>取chal，用来给chalHF.getGenChalH</li>
<li>取chal的配置，用来赋值</li>
<li>如果需要生成一个，取i,t</li>
<li>chalP.putChal(一堆参数)</li>
<li>isdirty存ch，需要生成存配置</li>
<li>ChalStatusRes,注意取之后要设一下下次生成时间</li>
</ul>
<h2 id="abandon"><a href="#abandon" class="headerlink" title="abandon"></a>abandon</h2><p><strong>抛弃一个活动的挑战，将不会给玩家奖励</strong></p>
<ul>
<li>v</li>
<li>取chal,扔给abChal,chalP.putChal</li>
<li><strong>生成下一个挑战的category，应该在更新挑战状态之后生成，以使我们部分失败时只影响客户端不知道下一个category是什么，也不能显示本地通知</strong>  <ul>
<li>取角色，chal配置</li>
<li>decrementChalPoolRuleCounts <strong>减少与挑战配置相关的挑战池规则计数。一个规则的计数会减少如果该规则和chal category生成同时重复。目的是让玩家在无法获得该分类(category,注意与Catalog相区别!)的新挑战时，更多的尝试为该分类生成挑战。</strong>(?)</li>
<li>然后生成下一个ChalCate,添加下一个Cate</li>
<li>saveChalConfig</li>
</ul>
</li>
<li><strong>我们只需要保存ch如果生成下一个挑战分类导致修改了角色(因为我们在一个新的挑战season里面)</strong><br>啰嗦一堆，判断就是dirty</li>
<li>AbChalRes</li>
</ul>
<h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><ul>
<li>v</li>
<li>取chal</li>
<li>uChalH.update</li>
<li>return chalP.putChal</li>
</ul>
<h2 id="complete"><a href="#complete" class="headerlink" title="complete"></a>complete</h2><p><strong>完成一个挑战，会确认挑战可以被完成，奖励玩家</strong>  </p>
<ul>
<li>v</li>
<li>取Chal,completeChalH.complete</li>
<li>取ch,i,用chalRewardH.collect()准备奖励</li>
<li><strong>生成下一个挑战分类因为他会在切换挑战季度时修改角色。然而直到我们保存chal状态我们都不会取保存它。</strong>  <ul>
<li>取Chal配置，</li>
<li>取Chal Pool</li>
<li>生成下一个ChalCate，添加下一个Cate</li>
</ul>
</li>
<li>更新i,w,ch,chal,chal更新:chalP.putChal</li>
<li>saveChalConfig （写了一段跟之前一样的注释,生成下一个挑战的category，应该那段，挺奇怪）</li>
<li>准备res,CompleteChalRes(一堆参数)<h2 id="seasonRankUp"><a href="#seasonRankUp" class="headerlink" title="seasonRankUp"></a>seasonRankUp</h2></li>
</ul>
<p><strong>增加挑战季节的排名并提供任何相关奖励</strong>  </p>
<ul>
<li>v</li>
<li>取角色，确认ch可以给chal season RankUp</li>
<li>取i,w</li>
<li>应用rankup注意用到玩家是否订阅,seasonRankUpH.rankup()</li>
<li>保存奖励和ch<h2 id="seasonPremiumReward"><a href="#seasonPremiumReward" class="headerlink" title="seasonPremiumReward"></a>seasonPremiumReward</h2></li>
</ul>
<p><strong>提供角色的高级订阅奖励</strong></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/company/" rel="tag"># company</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/20/%E9%A1%B9%E7%9B%AE%E7%9B%B8%E5%85%B3/" rel="next" title="项目相关">
                <i class="fa fa-chevron-left"></i> 项目相关
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2020/07/20/代码相关/"
           data-title="代码相关" data-url="http://oodtoodt.github.io/2020/07/20/%E4%BB%A3%E7%A0%81%E7%9B%B8%E5%85%B3/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/prpr.jpg"
               alt="eco_oodt" />
          <p class="site-author-name" itemprop="name">eco_oodt</p>
           
              <p class="site-description motion-element" itemprop="description">---自虐一点 开心一点</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">83</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#小tip"><span class="nav-number">1.</span> <span class="nav-text">小tip:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#auth"><span class="nav-number">2.</span> <span class="nav-text">auth</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#authAnonymous"><span class="nav-number">2.1.</span> <span class="nav-text">authAnonymous</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#authFirstParty"><span class="nav-number">2.2.</span> <span class="nav-text">authFirstParty</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#refershToken"><span class="nav-number">2.3.</span> <span class="nav-text">refershToken</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createAnonymousAccount"><span class="nav-number">2.4.</span> <span class="nav-text">createAnonymousAccount</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tryCreateAnonymousBnetAccount"><span class="nav-number">2.5.</span> <span class="nav-text">tryCreateAnonymousBnetAccount</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#authFirstParty-1"><span class="nav-number">2.6.</span> <span class="nav-text">authFirstParty</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tryProvideReceiptEarlyAccess"><span class="nav-number">2.7.</span> <span class="nav-text">tryProvideReceiptEarlyAccess</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linkFirstParty"><span class="nav-number">2.8.</span> <span class="nav-text">linkFirstParty</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linkBnetMasterAccount"><span class="nav-number">2.9.</span> <span class="nav-text">linkBnetMasterAccount</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linkForceFirstParty"><span class="nav-number">2.10.</span> <span class="nav-text">linkForceFirstParty</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linkForceBnetMasterAccount"><span class="nav-number">2.11.</span> <span class="nav-text">linkForceBnetMasterAccount</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shop"><span class="nav-number">3.</span> <span class="nav-text">shop</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#缩写"><span class="nav-number">3.1.</span> <span class="nav-text">缩写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#各项内容含义"><span class="nav-number">3.2.</span> <span class="nav-text">各项内容含义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#catalogs"><span class="nav-number">3.2.1.</span> <span class="nav-text">catalogs</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getSpS"><span class="nav-number">3.3.</span> <span class="nav-text">getSpS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流程"><span class="nav-number">3.3.1.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getShop"><span class="nav-number">3.4.</span> <span class="nav-text">getShop</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流程-1"><span class="nav-number">3.4.1.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#purSpBundle"><span class="nav-number">3.5.</span> <span class="nav-text">purSpBundle()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流程-2"><span class="nav-number">3.5.1.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#purB"><span class="nav-number">3.6.</span> <span class="nav-text">purB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getOrCreateSocialContactSCopy"><span class="nav-number">3.7.</span> <span class="nav-text">getOrCreateSocialContactSCopy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sellItems"><span class="nav-number">3.8.</span> <span class="nav-text">sellItems</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流程-3"><span class="nav-number">3.8.1.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#buyback"><span class="nav-number">3.9.</span> <span class="nav-text">buyback</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GSM"><span class="nav-number">4.</span> <span class="nav-text">GSM</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#缩写-1"><span class="nav-number">4.1.</span> <span class="nav-text">缩写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pur"><span class="nav-number">4.2.</span> <span class="nav-text">pur</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流程-4"><span class="nav-number">4.2.1.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getPur"><span class="nav-number">4.3.</span> <span class="nav-text">getPur</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#applyOfferLastChance"><span class="nav-number">4.4.</span> <span class="nav-text">applyOfferLastChance</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FulfillmentM"><span class="nav-number">5.</span> <span class="nav-text">FulfillmentM</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#缩写-2"><span class="nav-number">5.1.</span> <span class="nav-text">缩写</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MarketManager"><span class="nav-number">6.</span> <span class="nav-text">MarketManager</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#缩写-3"><span class="nav-number">6.1.</span> <span class="nav-text">缩写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cO"><span class="nav-number">6.2.</span> <span class="nav-text">cO</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流程-5"><span class="nav-number">6.2.1.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cancelO"><span class="nav-number">6.3.</span> <span class="nav-text">cancelO</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ChallengeM"><span class="nav-number">7.</span> <span class="nav-text">ChallengeM</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#generate"><span class="nav-number">7.1.</span> <span class="nav-text">generate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#abandon"><span class="nav-number">7.2.</span> <span class="nav-text">abandon</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#update"><span class="nav-number">7.3.</span> <span class="nav-text">update</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#complete"><span class="nav-number">7.4.</span> <span class="nav-text">complete</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#seasonRankUp"><span class="nav-number">7.5.</span> <span class="nav-text">seasonRankUp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#seasonPremiumReward"><span class="nav-number">7.6.</span> <span class="nav-text">seasonPremiumReward</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">eco_oodt</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"oodtoodtgithub"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  














  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("9nyYGut00EwMsBkAM79MHdVT-gzGzoHsz", "S2d0pfqMODa7ipkySemFGTdl");AV.useAVCloudUS();</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
